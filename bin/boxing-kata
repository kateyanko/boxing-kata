#!/usr/bin/env ruby

require "bundler/setup"
require "boxing/kata/boxing_kata"

Boxing::Kata::report


# **Importing family preferences**

# _As a Beam Shipping Manager_<br>
# _In order to ship perks_<br>
# _I want to add family member brush preferences_<br>

# To begin the boxing process the shipping manager must import family data.  When the system receives the input file then the brush color counts will be displayed in the format below.

# ```
# BRUSH PREFERENCES
# blue: 2
# green: 2
# pink: 1

require "csv" 
require "json"  

data = CSV.read("../spec/fixtures/family_preferences.csv", { encoding: "UTF-8", headers: true, header_converters: :symbol, converters: :all})

hashed_data = data.map { |d| d.to_hash }

$contract_date = hashed_data.map {|x| x.values[4]}

for i in $contract_date do 
  if i != nil 
    $primary_contract_date = i
  end
end

def scheduling_dates
  for i in 1..3 do
  $primary_contract_date += 90
  if i < 3
  print $primary_contract_date.strftime("%Y-%m-%d, ")
  else
    print $primary_contract_date.strftime("%Y-%m-%d\n")

end
end
$primary_contract_date -= 270
end


colors = hashed_data.map {|x| x.values[2]}

$colors_frequency_hash = {}

colors.each do |x|
    count = colors.count(x)
    $colors_frequency_hash[x] = count  
  end

$blue = $colors_frequency_hash["blue"]
$pink = $colors_frequency_hash["pink"]
$green = $colors_frequency_hash["green"]
$done1 = 0

def import_preferences
p "BRUSH PREFERENCES"
p "blue: " + $blue.to_s
p "pink: " + $pink.to_s
p "green: " + $green.to_s
end

import_preferences

# **Starter boxes**

def print_starter_boxes

until $blue <= 2
  puts "STARTER BOX"
  puts "2 blue brushes"
  puts  "2 blue replacement heads"
  $blue -= 2
  puts $primary_contract_date.strftime("%Y-%m-%d")
  puts "Mail class: priority"
end

puts "STARTER BOX"
puts $blue.to_s + " blue brushes"
puts  $blue.to_s + " blue replacement heads"
puts $primary_contract_date.strftime("%Y-%m-%d")
if $blue.to_i < 2
  puts "Mail class: first"
else
  puts "Mail class: priority"
end

until $green <= 2
  puts "STARTER BOX"
  puts "2 green brushes"
  puts  "2 green replacement heads"
  $green -= 2
  puts $primary_contract_date.strftime("%Y-%m-%d")
  puts "Mail class: priority"
end

puts "STARTER BOX"
puts $green.to_s + " green brushes"
puts  $green.to_s + " green replacement heads"
puts $primary_contract_date.strftime("%Y-%m-%d")
if $green.to_i < 2
  puts "Mail class: first"
else
  puts "Mail class: priority"
end

until $pink <= 2
  puts "STARTER BOX"
  puts "2 pink brushes"
  puts  "2 pink replacement heads"
  $pink -= 2
  puts $primary_contract_date.strftime("%Y-%m-%d")
  puts "Mail class: priority"
end

puts "STARTER BOX"
puts $pink.to_s + " pink brushes"
puts  $pink.to_s + " pink replacement heads"
puts $primary_contract_date.strftime("%Y-%m-%d")
if $pink.to_i < 2
  puts "Mail class: first"
else
  puts "Mail class: priority"
end
$done1 = 1
end

print_starter_boxes

if colors.count.to_i < 1
  puts "NO STARTER BOXES GENERATED"
end


# **Refills**

$blue_replacement = $colors_frequency_hash["blue"]
$pink_replacement = $colors_frequency_hash["pink"]
$green_replacement = $colors_frequency_hash["green"]

$replacement_colors = $blue_replacement.to_i + $pink_replacement.to_i + $green_replacement.to_i

def generate_refill_boxes
  if $done1 == 0
  puts "PLEASE GENERATE STARTER BOXES FIRST"
  else 
    pack_refill_boxes
  end
end

def pack_refill_boxes
  if $replacement_colors <= 4
    puts "REFILL BOX"
    puts $pink_replacement.to_s + " pink replacement heads"
    puts  $green_replacement.to_s + " green replacement heads"
    puts  $blue_replacement.to_s + " blue replacement heads"
    scheduling_dates
    puts "Mail class: first"
  else 
    pack_multiple_refill_boxes

end
end


def pack_multiple_refill_boxes 
  while $pink_replacement.to_i >= 4
    puts "REFILL BOX"
    puts "4 pink replacement heads"
    $pink_replacement -= 4
    scheduling_dates
    puts "Mail class: first"
  end

  $pink_leftover = $pink_replacement

  while $green_replacement.to_i >= 4
    puts "REFILL BOX"
    puts "4 green replacement heads"
    $green_replacement -= 4
    scheduling_dates
    puts "Mail class: first"
  end
    $green_leftover = $green_replacement
  while $blue_replacement.to_i >= 4
    puts "REFILL BOX"
    puts "4 blue replacement heads"
    $blue_replacement -= 4
    scheduling_dates
    puts "Mail class: first"
  end
    $blue_leftover = $blue_replacement
if $leftovers != 0 
      leftover_boxes
    end
end

$leftovers = {blue: $blue_leftover, pink: $pink_leftover, green: $green_leftover}

def leftover_boxes
  
  $box_capacity  = 4

  if $blue_leftover < 4 && $blue_leftover != 0
    puts "REFILL BOX"
    puts $blue_leftover.to_s + " blue replacement heads"
    $box_capacity = $box_capacity - $blue_leftover
    $blue_leftover = 0

    if $leftovers != 0 && $box_capacity != 0 
        if $green_leftover < $box_capacity
          puts $green_leftover.to_s + " green replacement heads"
          $box_capacity = $box_capacity - $green_leftover
          $green_leftover = 0
          
          if $box_capacity != 0 
            if $pink_leftover < $box_capacity
              puts $pink_leftover.to_s + " pink replacement heads"
              $box_capacity = $box_capacity - $pink_leftover
              $pink_leftover = 0
              scheduling_dates
              puts "Mail class: first"
            end
          else 
            leftover_boxes
          end
        else
          puts $box_capacity.to_s + " green replacement heads"
          $green_leftover = $green_leftover - $box_capacity
          scheduling_dates
          puts "Mail class: first"
          leftover_boxes
        end
      end
    end

  if $green_leftover < 4 && $green_leftover != 0
    puts "REFILL BOX"
          puts $green_leftover.to_s + " green replacement heads"
          $box_capacity = $box_capacity - $green_leftover
          $green_leftover = 0
          scheduling_dates
          puts "Mail class: first"
          if $leftovers != 0 && $box_capacity != 0 
              if $pink_leftover < $box_capacity
                puts $pink_leftover.to_s + " pink replacement heads"
                $box_capacity = $box_capacity - $pink_leftover
                $pink_leftover = 0
                scheduling_dates
                puts "Mail class: first"
              else 
                puts $box_capacity.to_s + " pink replacement heads"
                $pink_leftover = $pink_leftover - $box_capacity
                leftover_boxes
              end
            end
          end
    
if $pink_leftover < 4 && $pink_leftover != 0
puts "REFILL BOX"
  puts $pink_leftover.to_s + " pink replacement heads"
  $pink_leftover = 0
  scheduling_dates
  puts "Mail class: first"
end
end


generate_refill_boxes


# **Paste Kits**

# _As a Beam shipping manager_<br>
# _In order to ship paste kits_<br>
# _I want to add paste kits to the boxes_<br>

# When a brush or replacement head is shipped a paste kit is also shipped which contains toothpaste and floss. A paste kit weighs 7.6 oz which will impact on the mail class choice.

# Example for a starter box:
# ```
# STARTER BOX
# 1 pink brushes
# 1 pink replacement head
# 1 paste kit
# Schedule: 2018-01-01
# Mail class: priority
# ```

# Example for a refill box:
# ```
# REFILL BOX
# 1 pink replacement head
# 1 paste kit
# Schedule: 2018-04-01, 2018-06-30, 2018-09-28
# Mail class: first
# ```



